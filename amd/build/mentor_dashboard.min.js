/**
 * AMD module: enrol_mentorsubscription/mentor_dashboard (built)
 *
 * Pre-built RequireJS-format module. Source lives in amd/src/mentor_dashboard.js.
 * Regenerate with: grunt amd --root=enrol/mentorsubscription
 *
 * @copyright 2026 LMS Doctor <info@lmsdoctor.com>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(
"enrol_mentorsubscription/mentor_dashboard",
["core/ajax","core/notification","core/modal_factory","core/modal_events","core/str"],
function(Ajax, Notification, ModalFactory, ModalEvents, Str) {

    /** @type {HTMLElement} */
    let dashboardRoot = null;

    // -----------------------------------------------------------------------
    // Toggle switch
    // -----------------------------------------------------------------------
    const updateBadge = (toggle, isActive) => {
        const card  = toggle.closest('[data-menteeid]');
        if (!card) return;
        const badge = card.querySelector('.badge');
        if (!badge) return;

        Str.get_strings([
            {key: 'mentee_active',   component: 'enrol_mentorsubscription'},
            {key: 'mentee_inactive', component: 'enrol_mentorsubscription'},
        ]).then(function(strs) {
            if (isActive) {
                badge.textContent = strs[0];
                badge.classList.replace('badge-secondary', 'badge-success');
            } else {
                badge.textContent = strs[1];
                badge.classList.replace('badge-success', 'badge-secondary');
            }
            return null;
        }).catch(Notification.exception);
    };

    const updateCounter = (activeCount, maxMentees) => {
        const countEl = dashboardRoot.querySelector('[data-region="active-count"]');
        if (countEl) {
            countEl.textContent = activeCount + ' / ' + maxMentees;
        }
        const bar = dashboardRoot.querySelector('.progress-bar');
        if (bar && maxMentees > 0) {
            const pct = Math.round((activeCount / maxMentees) * 100);
            bar.style.width = pct + '%';
            bar.setAttribute('aria-valuenow', activeCount);
            bar.classList.toggle('bg-danger',  activeCount >= maxMentees);
            bar.classList.toggle('bg-success', activeCount <  maxMentees);
        }
        const limitCard = dashboardRoot.querySelector('[data-region="limit-reached-card"]');
        if (limitCard) {
            limitCard.classList.toggle('d-none', activeCount < maxMentees);
        }
        const addBtn = dashboardRoot.querySelector('[data-action="add-mentee"]');
        if (addBtn) {
            addBtn.classList.toggle('d-none', activeCount >= maxMentees);
        }
    };

    const bindToggleSwitches = () => {
        dashboardRoot.addEventListener('change', function(e) {
            const toggle = e.target.closest('.enrol-mentorsub-status-toggle');
            if (!toggle) return;

            const menteeid = parseInt(toggle.dataset.menteeid, 10);
            const isActive = toggle.checked ? 1 : 0;

            updateBadge(toggle, isActive);

            Ajax.call([{
                methodname: 'enrol_mentorsubscription_toggle_mentee_status',
                args: {menteeid: menteeid, is_active: isActive},
            }])[0].done(function(result) {
                if (!result.success) {
                    toggle.checked = !toggle.checked;
                    updateBadge(toggle, isActive === 1 ? 0 : 1);
                    Str.get_strings([
                        {key: 'error_limit_reached', component: 'enrol_mentorsubscription'},
                    ]).then(function(strs) {
                        Notification.alert('', strs[0]);
                        return null;
                    }).catch(Notification.exception);
                } else {
                    updateCounter(result.active_count, result.max_mentees);
                }
            }).fail(function(ex) {
                toggle.checked = !toggle.checked;
                updateBadge(toggle, isActive === 1 ? 0 : 1);
                Notification.exception(ex);
            });
        });
    };

    // -----------------------------------------------------------------------
    // Add mentee modal
    // -----------------------------------------------------------------------
    const buildAddMenteeForm = () => {
        return '<div class="form-group mb-3">' +
            '<label for="mentorsub-new-menteeid" class="form-label">User ID</label>' +
            '<input type="number" min="1" id="mentorsub-new-menteeid"' +
            ' class="form-control" placeholder="e.g. 42" required />' +
            '<div id="mentorsub-add-error" class="invalid-feedback"></div>' +
            '</div>';
    };

    const handleAddMenteeSubmit = (modal) => {
        const input = modal.getRoot()[0].querySelector('#mentorsub-new-menteeid');
        const menteeid = parseInt(input ? input.value : '0', 10);

        if (!menteeid || menteeid <= 0) {
            if (input) input.classList.add('is-invalid');
            return;
        }

        Ajax.call([{
            methodname: 'enrol_mentorsubscription_add_mentee',
            args: {menteeid: menteeid},
        }])[0].done(function(result) {
            if (result.success) {
                modal.hide();
                window.location.reload();
            } else {
                const errDiv = modal.getRoot()[0].querySelector('#mentorsub-add-error');
                if (errDiv) errDiv.textContent = result.message;
                if (input)  input.classList.add('is-invalid');
            }
        }).fail(function(ex) {
            modal.hide();
            Notification.exception(ex);
        });
    };

    const bindAddMenteeButton = () => {
        dashboardRoot.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-action="add-mentee"]');
            if (!btn) return;
            e.preventDefault();

            Str.get_strings([
                {key: 'dashboard_add_mentee', component: 'enrol_mentorsubscription'},
            ]).then(function(strs) {
                return ModalFactory.create({
                    type:  ModalFactory.types.SAVE_CANCEL,
                    title: strs[0],
                    body:  buildAddMenteeForm(),
                });
            }).then(function(modal) {
                modal.getRoot().on(ModalEvents.save, function() {
                    handleAddMenteeSubmit(modal);
                });
                modal.show();
                return modal;
            }).catch(Notification.exception);
        });
    };

    // -----------------------------------------------------------------------
    // Public init
    // -----------------------------------------------------------------------
    return {
        init: function() {
            dashboardRoot = document.querySelector('[data-region="mentor-dashboard"]');
            if (!dashboardRoot) return;
            bindToggleSwitches();
            bindAddMenteeButton();
        }
    };
});
